{% extends "base.html" %}

{% block content %}
<div class="row mb-3">
    <div class="col">
        <a href="/calendar" class="btn btn-primary">
            <i class="bi bi-calendar"></i> Ver Calendario
        </a>
        <div class="btn-group ms-2">
            <a href="/?limit=10{% if request.args.get('date') %}&date={{ request.args.get('date') }}{% endif %}" class="btn btn-secondary {% if not request.args.get('limit') or request.args.get('limit') == '10' %}active{% endif %}">
                <i class="bi bi-list-ul"></i> 10
            </a>
            <a href="/?limit=30{% if request.args.get('date') %}&date={{ request.args.get('date') }}{% endif %}" class="btn btn-secondary {% if request.args.get('limit') == '30' %}active{% endif %}">
                <i class="bi bi-list-ul"></i> 30
            </a>
            <a href="/?limit=50{% if request.args.get('date') %}&date={{ request.args.get('date') }}{% endif %}" class="btn btn-secondary {% if request.args.get('limit') == '50' %}active{% endif %}">
                <i class="bi bi-list-ul"></i> 50
            </a>
            <a href="/?limit=100{% if request.args.get('date') %}&date={{ request.args.get('date') }}{% endif %}" class="btn btn-secondary {% if request.args.get('limit') == '100' %}active{% endif %}">
                <i class="bi bi-list-ul"></i> 100
            </a>
            <a href="/?limit=300{% if request.args.get('date') %}&date={{ request.args.get('date') }}{% endif %}" class="btn btn-secondary {% if request.args.get('limit') == '300' %}active{% endif %}">
                <i class="bi bi-list-ul"></i> 300
            </a>
            <a href="/?limit=500{% if request.args.get('date') %}&date={{ request.args.get('date') }}{% endif %}" class="btn btn-secondary {% if request.args.get('limit') == '500' %}active{% endif %}">
                <i class="bi bi-list-ul"></i> 500
            </a>
            <a href="/?limit=all{% if request.args.get('date') %}&date={{ request.args.get('date') }}{% endif %}" class="btn btn-secondary {% if request.args.get('limit') == 'all' %}active{% endif %}">
                <i class="bi bi-list-check"></i> Todos
            </a>
        </div>

        <button id="downloadCsvBtn" class="btn btn-success ms-2">
            <i class="bi bi-file-earmark-excel"></i> Exportar CSV
        </button>
        {% if request.args.get('date') %}
        <span class="ms-3 align-middle">
            <i class="bi bi-calendar-date"></i> Filtrado: {{ request.args.get('date') }}
            <a href="/" class="btn btn-sm btn-outline-danger ms-2">
                <i class="bi bi-x-circle"></i> Limpiar
            </a>
        </span>
        {% endif %}
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h2>Datos del Sensor</h2>
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="showValuesToggle" checked>
                    <label class="form-check-label" for="showValuesToggle">Mostrar valores</label>
                </div>
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="showIntervalsToggle" checked>
                    <label class="form-check-label" for="showIntervalsToggle">Mostrar intervalos</label>
                </div>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="chartTypeSelect" class="form-label">Tipo de gráfica:</label>
                        <select class="form-select" id="chartTypeSelect">
                            <option value="line">Línea</option>
                            <option value="bubble">Burbujas</option>
                            <option value="doughnut">Donut</option>
                            <option value="polarArea">Polar</option>
                            <option value="radar">Radar</option>
                            <option value="bar">Barras</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label for="timeRangeSelect" class="form-label">Rango de tiempo:</label>
                        <div class="input-group">
                            <input type="datetime-local" id="startTimeFilter" class="form-control">
                            <span class="input-group-text">a</span>
                            <input type="datetime-local" id="endTimeFilter" class="form-control">
                            <button class="btn btn-primary" type="button" id="applyTimeFilter">
                                <i class="bi bi-filter"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body" style="position: relative; height: 400px;">
                    <canvas id="sensorChart" style="width: 100%; height: 100%;"></canvas>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5>Registros</h5>
                <div class="input-group" style="width: 250px;">
                    <input type="date" id="dateFilter" class="form-control form-control-sm">
                    <button class="btn btn-outline-primary btn-sm" type="button" id="applyDateFilter">
                        <i class="bi bi-filter"></i> Filtrar
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                    <table class="table table-striped table-hover">
                        <thead class="sticky-top bg-light">
                            <tr>
                                <th>Valor</th>
                                <th>Fecha/Hora</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in data %}
                            <tr>
                                <td>{{ item.value }}</td>
                                <td>{{ item.timestamp }}</td>
                                <td>
                                    <a href="/?date={{ item.timestamp.split(' ')[0] }}{% if request.args.get('limit') %}&limit={{ request.args.get('limit') }}{% endif %}" class="btn btn-sm btn-outline-info">
                                        <i class="bi bi-calendar-day"></i> Día
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card mb-4">
            <div class="card-header bg-success text-white">
                <h5>Estado del Sistema</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <strong>Actual:</strong>
                    <span id="last-reading">Cargando...</span>
                </div>
                <hr>
                <div class="mb-3">
                    <strong>Red WiFi actual:</strong>
                    <span id="current-wifi">Cargando...</span>
                </div>
                <div class="mb-3">
                    <strong>Dirección IP:</strong>
                    <span id="current-ip">Cargando...</span>
                </div>
                <hr>
                <div class="mb-3">
                    <strong>Registros totales:</strong>
                    <span id="total-records">Cargando...</span>
                </div>
                <div class="mb-3">
                    <strong>Promedio diario:</strong>
                    <span id="daily-avg">Cargando...</span>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5>Resumen del Día</h5>
            </div>
            <div class="card-body">
                <div id="daily-summary">
                    <p class="text-muted">Seleccione un día para ver el resumen</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom"></script>
<script src="https://cdn.jsdelivr.net/npm/moment"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-moment"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Variables globales
    let sensorChart;
    let rawData = [];
    
    // Obtener parámetros de la URL
    const urlParams = new URLSearchParams(window.location.search);
    const dateFilter = urlParams.get('date');
    const limit = urlParams.get('limit');
    
    // Configurar elementos de la UI según los parámetros
    if (dateFilter) {
        document.getElementById('dateFilter').value = dateFilter;
        updateDailySummary(dateFilter);
    }

    // Cargar datos iniciales
    loadData();

    // Configurar eventos
    document.getElementById('downloadCsvBtn').addEventListener('click', downloadCSV);
    document.getElementById('applyDateFilter').addEventListener('click', applyDateFilter);
    document.getElementById('applyTimeFilter').addEventListener('click', applyTimeFilter);
    document.getElementById('showIntervalsToggle').addEventListener('change', updateChartData);
    document.getElementById('showValuesToggle').addEventListener('change', updateChartData);
    document.getElementById('chartTypeSelect').addEventListener('change', updateChartType);

    function applyDateFilter() {
        const dateValue = document.getElementById('dateFilter').value;
        if (dateValue) {
            window.location.href = `/?date=${dateValue}`;
        }
    }

    function applyTimeFilter() {
        const startTime = document.getElementById('startTimeFilter').value;
        const endTime = document.getElementById('endTimeFilter').value;
        
        if (startTime && endTime) {
            const filteredData = filterDataByTimeRange(rawData, startTime, endTime);
            updateChartWithData(filteredData);
        } else {
            updateChartWithData(rawData);
        }
    }

    function filterDataByTimeRange(data, startTime, endTime) {
        const start = new Date(startTime);
        const end = new Date(endTime);
        return data.filter(item => {
            const itemTime = new Date(item.timestamp);
            return itemTime >= start && itemTime <= end;
        });
    }

    // Función para cargar datos
    function loadData() {
        let apiUrl = '/api/sensor/data?';
        if (dateFilter) apiUrl += `date=${dateFilter}&`;
        if (limit) apiUrl += `limit=${limit}`;

        fetch(apiUrl)
            .then(response => response.json())
            .then(data => {
                rawData = data.data;
                updateChartWithData(rawData);
                updateSystemInfo();
                updateStatistics();
                
                // Configurar rangos de tiempo
                if (rawData.length > 0) {
                    const firstDate = new Date(rawData[0].timestamp);
                    const lastDate = new Date(rawData[rawData.length - 1].timestamp);
                    
                    document.getElementById('startTimeFilter').value = formatDateTimeLocal(firstDate);
                    document.getElementById('endTimeFilter').value = formatDateTimeLocal(lastDate);
                }
            });
    }

    function formatDateTimeLocal(date) {
        return date.toISOString().slice(0, 16);
    }

    function updateChartWithData(data) {
        const showIntervals = document.getElementById('showIntervalsToggle').checked;
        const showValues = document.getElementById('showValuesToggle').checked;
        const chartType = document.getElementById('chartTypeSelect').value;
        
        // Preparar datos
        const sortedData = data.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
        const timestamps = sortedData.map(item => item.timestamp);
        const values = sortedData.map(item => item.value);
        
        // Calcular intervalos si es necesario
        let intervals = [];
        if (showIntervals && sortedData.length > 1) {
            for (let i = 1; i < sortedData.length; i++) {
                const prevTime = new Date(sortedData[i-1].timestamp);
                const currTime = new Date(sortedData[i].timestamp);
                intervals.push((currTime - prevTime) / 1000);
            }
            // Añadir un 0 al principio para mantener la misma longitud
            intervals.unshift(0);
        }
        
        // Actualizar gráfica
        updateChart({
            timestamps: timestamps,
            values: values,
            intervals: intervals,
            chartType: chartType,
            showIntervals: showIntervals,
            showValues: showValues
        });
    }

    function updateChartData() {
        updateChartWithData(rawData);
    }

    function updateChartType() {
        if (sensorChart) {
            sensorChart.config.type = document.getElementById('chartTypeSelect').value;
            sensorChart.update();
        }
    }

    // Función para opciones comunes de gráficas
    function getCommonChartOptions() {
        return {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                zoom: {
                    zoom: {
                        wheel: { enabled: true },
                        pinch: { enabled: true },
                        mode: 'xy',
                    },
                    pan: {
                        enabled: true,
                        mode: 'xy',
                    },
                    limits: {
                        x: { min: 'original', max: 'original' },
                        y: { min: 'original', max: 'original' }
                    }
                },
                tooltip: {
                    mode: 'index',
                    intersect: false
                },
                legend: {
                    position: 'top',
                }
            },
            scales: {
                x: {
                    type: 'time',
                    time: {
                        tooltipFormat: 'YYYY-MM-DD HH:mm:ss',
                        displayFormats: {
                            hour: 'HH:mm',
                            day: 'MMM D',
                            week: 'MMM D',
                            month: 'MMM YYYY',
                            year: 'YYYY'
                        }
                    },
                    title: { display: true, text: 'Tiempo' },
                    grid: { display: true }
                },
                y: {
                    title: { display: true, text: 'Valor' },
                    beginAtZero: false,
                    grid: { display: true }
                }
            },
            interaction: {
                intersect: false,
                mode: 'index'
            }
        };
    }

    // Actualizar el gráfico principal
    function updateChart(data) {
        const ctx = document.getElementById('sensorChart').getContext('2d');
        
        // Destruir la gráfica anterior si existe
        if (sensorChart && typeof sensorChart.destroy === 'function') {
            sensorChart.destroy();
        }


        
        // Verificar que tenemos datos para mostrar
        if (data.timestamps.length === 0) {
            console.warn('No hay datos para mostrar en el gráfico');
            return;
        }

        try {
            // Preparar datasets
            const datasets = [];

            if (data.showValues && data.values.length > 0) {
                datasets.push({
                    label: 'Valores',
                    data: data.values,
                    borderColor: 'rgba(75, 192, 192, 1)',
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    borderWidth: 1,
                    yAxisID: 'y'
                });
            }

            if (data.showIntervals && data.intervals.length > 0) {
                datasets.push({
                    label: 'Intervalo entre lecturas (segundos)',
                    data: data.intervals,
                    borderColor: 'rgba(255, 99, 132, 1)',
                    backgroundColor: 'rgba(255, 99, 132, 0.1)',
                    borderWidth: 1,
                    //type: data.chartType,
                    yAxisID: 'y1'
                });
            }

            sensorChart = new Chart(ctx, {
                type: data.chartType,
                data: {
                    labels: data.timestamps,
                    datasets: datasets
                },
                options: {
                    ...getCommonChartOptions(),
                    scales: {
                        ...getCommonChartOptions().scales,
                        y1: {
                            type: 'linear',
                            display: data.showIntervals,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Segundos'
                            },
                            grid: {
                                drawOnChartArea: false
                            }
                        }
                    }
                }
            });

        } catch (error) {
            console.error('Error al crear el gráfico:', error);
        }
    }

    // Función para descargar CSV
    function downloadCSV() {
        const dateFilter = document.getElementById('dateFilter').value;
        const currentDate = dateFilter || new Date().toISOString().split('T')[0];
        const currentTime = new Date().toTimeString().split(' ')[0].replace(/:/g, '-');
        const filename = `${currentDate}-${currentTime}-rud1.csv`;
        
        let apiUrl = '/api/sensor/data?';
        if (dateFilter) apiUrl += `date=${dateFilter}&`;
        apiUrl += 'limit=all';
        
        fetch(apiUrl)
            .then(response => response.json())
            .then(data => {
                if (data.data && data.data.length > 0) {
                    const sortedData = data.data.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                    const dataWithTimeDiff = sortedData.map((item, index, array) => {
                        if (index === 0) {
                            return {...item, time_diff: 0};
                        }
                        const prevTime = new Date(array[index-1].timestamp);
                        const currTime = new Date(item.timestamp);
                        const diffSeconds = Math.round((currTime - prevTime) / 1000);
                        return {...item, time_diff: diffSeconds};
                    });
                    
                    let csvContent = "Valor,Fecha/Hora,Tiempo entre lecturas (segundos)\n";
                    dataWithTimeDiff.forEach(item => {
                        csvContent += `${item.value},${item.timestamp},${item.time_diff}\n`;
                    });
                    
                    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.setAttribute('href', url);
                    link.setAttribute('download', filename);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                } else {
                    alert('No hay datos para exportar.');
                }
            })
            .catch(error => {
                console.error('Error al generar CSV:', error);
                alert('Error al generar el archivo CSV.');
            });
    }

    // Actualizar información del sistema
    function updateSystemInfo() {
        fetch('/api/system/info')
            .then(response => response.json())
            .then(data => {
                document.getElementById('current-wifi').textContent = data.wifi_ssid || 'Desconocido';
                document.getElementById('current-ip').textContent = data.ip_address || 'Desconocido';
                
                if (data.last_reading) {
                    document.getElementById('last-reading').textContent = 
                        `${data.last_reading.value} (${data.last_reading.timestamp})`;
                }
            });
    }

    // Actualizar estadísticas
    function updateStatistics() {
        fetch('/api/sensor/daily_stats')
            .then(response => response.json())
            .then(data => {
                const totalRecords = data.reduce((sum, day) => sum + day.count, 0);
                const dailyAvg = data[0]?.average || 0;
                document.getElementById('total-records').textContent = totalRecords;
                document.getElementById('daily-avg').textContent = dailyAvg.toFixed(2);
            });
    }

    // Actualizar resumen diario
    function updateDailySummary(date) {
        fetch(`/api/sensor/daily_stats?date=${date}`)
            .then(response => response.json())
            .then(data => {
                if (data.length > 0) {
                    const dayData = data.find(d => d.day === date) || data[0];
                    document.getElementById('daily-summary').innerHTML = `
                        <ul class="list-group">
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                Registros
                                <span class="badge bg-primary rounded-pill">${dayData.count}</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                Valor Máximo
                                <span class="badge bg-success rounded-pill">${dayData.max_value}</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                Promedio
                                <span class="badge bg-info rounded-pill">${dayData.average.toFixed(2)}</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                Promedio entre lecturas
                                <span class="badge bg-dark rounded-pill">${dayData.avg_diff} seg</span>
                            </li>
                        </ul>
                    `;
                }
            });
    }

    // Actualizar datos periódicamente
    setInterval(() => {
        updateSystemInfo();
    }, 10000);
});
</script>
{% endblock %}